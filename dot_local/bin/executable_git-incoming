#!/bin/sh
# git-incoming - Show commits on remote not yet merged locally
#
# Usage: git-incoming [-d] [<upstream>] [<head> [<limit>]]
#
# Shows commits on <upstream> that do not exist on current branch.
# With -d/--diff, shows the actual diff instead of commit list.
# If no upstream is given, uses the tracking branch.

die() {
    echo "$(basename $0):" "$@" 1>&2
    exit 1
}

# colors
SHA=$(git config --get-color 'color.branch.local')
ADD=$(git config --get-color 'color.diff.new')
REM=$(git config --get-color 'color.diff.old')
RESET=$(git config --get-color '' 'reset')

# check for -d / --diff argument
diff=false
if [ "$1" = '-d' ] || [ "$1" = '--diff' ]; then
    diff=true
    shift
fi

# use tracking branch if no upstream given
if [ $# -eq 0 ]; then
    ref=$(git symbolic-ref -q HEAD)
    test -n "$ref" || die "you're not on a branch"

    branch=$(echo "$ref" | sed 's@^refs/heads/@@')
    test -n "$branch" || die "you're in a weird place; get on a local branch"

    remote=$(git config --get "branch.$branch.remote" || true)
    merge=$(git config branch.$branch.merge) ||
        die "branch $branch isn't tracking a remote branch and no <upstream> given"

    set -- "$remote/$(echo "$merge" | sed 's@^refs/heads/@@')"
fi

if $diff; then
    git diff HEAD..."$1"
else
    git cherry -v HEAD "$@" |
        cut -c1-9 -c43- |
        sed -e "s/^\(.\) \(.......\)/\1 $SHA\2$RESET/" |
        sed -e "s/^-/$REM-$RESET/" -e "s/^+/$ADD+$RESET/"
fi
