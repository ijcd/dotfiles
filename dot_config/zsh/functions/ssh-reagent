# Find a usable SSH agent
# Usage: ssh-reagent [-v]
#   -v  Verbose: show agent info when found
function ssh-reagent () {
  local verbose=0
  [[ "$1" == "-v" ]] && verbose=1

  for agent in ${TMPDIR}ssh-*/agent.*(N); do
    # Only use sockets owned by us
    [[ -O $agent ]] || continue
    export SSH_AUTH_SOCK=$agent
    if ssh-add -l &>/dev/null; then
      if (( verbose )); then
        echo "Found working SSH Agent:"
        ssh-add -l
      fi
      return 0
    fi
  done
  echo 'Cannot find ssh agent - maybe you should reconnect and forward it?' >&2
  return 1
}
